name: Auto-Update README

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'src/**'
      - 'lib/**'
      - '*.py'
      - '*.js'
      - '*.ts'
      - 'package.json'
      - 'requirements.txt'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze Repository
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const repo = context.repo;
            const { data: repoData } = await github.rest.repos.get({
              owner: repo.owner,
              repo: repo.repo,
            });
            
            const getLanguageStats = () => {
              let stats = {};
              const extensions = {
                '.js': 'JavaScript',
                '.ts': 'TypeScript',
                '.py': 'Python',
                '.java': 'Java',
                '.cpp': 'C++',
                '.c': 'C',
                '.go': 'Go',
                '.rs': 'Rust',
                '.rb': 'Ruby',
                '.php': 'PHP',
              };
              
              const walkDir = (dir) => {
                try {
                  const files = fs.readdirSync(dir);
                  files.forEach(file => {
                    const fullPath = path.join(dir, file);
                    if (fs.statSync(fullPath).isDirectory() && !file.startsWith('.')) {
                      walkDir(fullPath);
                    } else {
                      const ext = path.extname(file);
                      const lang = extensions[ext];
                      if (lang) stats[lang] = (stats[lang] || 0) + 1;
                    }
                  });
                } catch(e) {}
              };
              
              walkDir('.');
              return stats;
            };
            
            const languageStats = getLanguageStats();
            
            core.setOutput('repo-name', repo.repo);
            core.setOutput('repo-description', repoData.description || 'No description');
            core.setOutput('stars', repoData.stargazers_count);
            core.setOutput('forks', repoData.forks_count);
            core.setOutput('language', repoData.language || 'Not Specified');
            core.setOutput('language-stats', JSON.stringify(languageStats));
            core.setOutput('topics', JSON.stringify(repoData.topics || []));

      - name: Generate/Update README
        id: generate-readme
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          cat > README.md << EOF
          # ${{ steps.analyze.outputs.repo-name }}
          
          ${{ steps.analyze.outputs.repo-description }}
          
          ## Repository Statistics
          
          [![Stars](https://img.shields.io/github/stars/${{ github.repository }}?style=flat-square)](https://github.com/${{ github.repository }}/stargazers)
          [![Forks](https://img.shields.io/github/forks/${{ github.repository }}?style=flat-square)](https://github.com/${{ github.repository }}/network/members)
          [![Issues](https://img.shields.io/github/issues/${{ github.repository }}?style=flat-square)](https://github.com/${{ github.repository }}/issues)
          [![Language](https://img.shields.io/github/languages/top/${{ github.repository }}?style=flat-square)]()
          [![License](https://img.shields.io/badge/License-MIT-blue.svg?style=flat-square)]()
          
          ## Technologies Used
          
          - **Primary Language:** ${{ steps.analyze.outputs.language }}
          - **Last Updated:** $TIMESTAMP
          
          ## Quick Start
          
          \`\`\`bash
          # Clone the repository
          git clone https://github.com/${{ github.repository }}.git
          cd ${{ steps.analyze.outputs.repo-name }}
          
          # Install dependencies
          # npm install
          # or
          # pip install -r requirements.txt
          \`\`\`
          
          ## Documentation
          
          - [Contributing Guidelines](./CONTRIBUTING.md)
          - [Code of Conduct](./CODE_OF_CONDUCT.md)
          
          ## Contributing
          
          Contributions are welcome! Please feel free to submit a Pull Request.
          
          ## License
          
          This project is licensed under the MIT License - see the LICENSE file for details.
          
          ---
          
          **Last Auto-Generated:** $TIMESTAMP
          
          **Generated by:** [Auto-README Generator](https://github.com/ProHamedM/auto-readme-generator)
          EOF

      - name: Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          if [ ! -f README.md ] || ! git diff --quiet README.md; then
            git add README.md
            git commit -m "Auto-update README [skip ci]"
            git push origin HEAD:${{ github.ref }}
          else
            echo "No changes in README"
          fi
